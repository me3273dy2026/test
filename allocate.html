<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topic Allocation | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.card{
  background:#ffffff;
  width:92%;
  max-width:520px;
  margin-top:30px;
  padding:22px;
  border-radius:18px;
  box-shadow:0 18px 40px rgba(0,0,0,.25);
}
.header{
  text-align:center;
  font-size:15.5px;
  font-weight:600;
  color:#203a43;
}
.sub{
  text-align:center;
  font-size:13px;
  color:#666;
  margin-bottom:16px;
}
.info-box{
  background:#f4f7fa;
  padding:14px 16px;
  border-radius:12px;
  margin-bottom:14px;
}
.info-title{
  font-size:12px;
  font-weight:700;
  color:#2c5364;
  margin-bottom:6px;
  text-transform:uppercase;
}
.info-content{
  font-size:14.5px;
}
.status-red{
  background:#fdecea;
  color:#b71c1c;
  padding:12px;
  border-radius:12px;
  font-weight:400;   /* normal text */
  text-align:center;
  margin-top:12px;
}

/* ---------- WHEEL ---------- */
.wheel-wrap{
  position:relative;
  width:240px;
  height:240px;
  margin:18px auto;
}
#wheel{
  width:100%;
  height:100%;
  border-radius:50%;
  border:6px solid #203a43;
  background:conic-gradient(
    #1abc9c 0deg 40deg,
    #3498db 40deg 80deg,
    #9b59b6 80deg 120deg,
    #e67e22 120deg 160deg,
    #e74c3c 160deg 200deg,
    #f1c40f 200deg 240deg,
    #16a085 240deg 280deg,
    #2980b9 280deg 320deg,
    #8e44ad 320deg 360deg
  );
}
.pointer{
  position:absolute;
  top:-12px;
  left:50%;
  transform:translateX(-50%);
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:18px solid #c0392b;
}
.center{text-align:center;}
button{
  padding:12px 26px;
  border:none;
  border-radius:30px;
  background:linear-gradient(135deg,#2c5364,#203a43);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.logout{
  margin-top:18px;
}
.logout button{
  background:#c0392b;
}
.footer{
  margin-top:14px;
  text-align:center;
  font-size:12px;
  color:#e0e0e0;
}
.footer div{margin-top:2px;}
</style>
</head>

<body>

<div class="card">
  <div id="header" class="header">Loading…</div>
  <div class="sub">Group Discussion & Seminar (ME3273)</div>
  <div id="content">Checking allocation status…</div>
</div>

<div class="logout">
  <button id="logoutBtn" onclick="logout()">Logout</button>
</div>

<div class="footer">
  Developed by Rajesh Akula
  <div>© 2026 · IIEST Shibpur</div>
</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbxCDnzwzQaTPPMHe_wyOM4EiEObwktVK7_c2zcVfAow9f9K1nyjDHiFlwbtafCEQcW9lg/exec";

const token = new URLSearchParams(window.location.search).get("token");
const content = document.getElementById("content");
const header  = document.getElementById("header");
const logoutBtn = document.getElementById("logoutBtn");

/* ---------- INITIAL LOAD ---------- */
fetch(BACKEND,{
  method:"POST",
  body:new URLSearchParams({ action:"dashboard", token })
})
.then(r=>r.json())
.then(res=>{
  if(res.status==="ASSIGNED"){
    showAssigned(res);
  }else{
    showWheel();
  }
});

/* ---------- SHOW WHEEL ---------- */
function showWheel(){
  header.innerText="Welcome!";
  content.innerHTML=`
    <div class="wheel-wrap">
      <div class="pointer"></div>
      <div id="wheel"></div>
    </div>
    <div class="center">
      <button id="spinBtn" onclick="spin()">Spin the Wheel</button>
    </div>
  `;
}

/* ---------- SPIN ---------- */
function spin(){
  const btn=document.getElementById("spinBtn");
  btn.style.display="none";  // hide immediately

  content.innerHTML += `
    <div class="status-red">
      Allocating topic… Please wait.
    </div>
  `;

  const wheel=document.getElementById("wheel");
  wheel.style.transition="none";
  wheel.style.transform="rotate(0deg)";

  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      wheel.style.transition="transform 4s ease-out";
      wheel.style.transform=
        `rotate(${360*5 + Math.random()*360}deg)`;
    });
  });

  setTimeout(assign,4200);
}

/* ---------- ASSIGN ---------- */
function assign(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"assign", token })
  })
  .then(r=>r.json())
  .then(showAssigned);
}

/* ---------- SHOW ASSIGNED ---------- */
function showAssigned(res){
  const me=res.team[0];
  header.innerText=`Welcome ${me.name} (${me.roll})`;

  let html=`
    <div class="info-box">
      <div class="info-title">Assigned Topic</div>
      <div class="info-content">
        ${res.project} – ${res.projectName}
      </div>
    </div>

    <div class="info-box">
      <div class="info-title">Group Members</div>
      ${res.team.map((s,i)=>`${i+1}. ${s.name} (${s.roll})`).join("<br>")}
    </div>
  `;

  if(!res.complete){
    html+=`
      <div class="status-red">
        A few students haven't spun the wheel yet.
        Please login later to see full group details.
      </div>
    `;
  }

  content.innerHTML=html;
}

/* ---------- LOGOUT ---------- */
function logout(){
  logoutBtn.style.display="none";

  content.innerHTML=`
    <div class="status-red">
      Logging out… Please wait.
    </div>
  `;

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"logout", token })
  }).finally(()=>{
    location.href="login.html";
  });
}
</script>

</body>
</html>
