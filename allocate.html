<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topic Allocation | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  display:flex;
  justify-content:center;
}
.card{
  background:#ffffff;
  width:100%;
  max-width:650px;
  margin:20px;
  padding:22px;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.28);
}
.header{
  text-align:center;
  font-size:17px;
  font-weight:600;
  color:#203a43;
}
.sub{
  text-align:center;
  font-size:13px;
  color:#666;
  margin-bottom:18px;
}
.section{
  margin-top:18px;
}
.info-box{
  background:#f7f9fb;
  border-left:5px solid #2c5364;
  padding:14px 16px;
  border-radius:10px;
  margin-bottom:14px;
}
.info-title{
  font-size:13px;
  font-weight:700;
  color:#2c5364;
  margin-bottom:6px;
  text-transform:uppercase;
}
.info-content{
  font-size:15px;
  color:#222;
}
#wheel{
  width:220px;height:220px;
  margin:20px auto;
  border-radius:50%;
  border:6px solid #203a43;
  background:conic-gradient(
    #1abc9c,#3498db,#9b59b6,#e67e22,#e74c3c,
    #f1c40f,#16a085,#2980b9,#8e44ad
  );
  transition:transform 4s cubic-bezier(.25,.1,.25,1);
}
#pointer{
  width:0;height:0;
  margin:0 auto;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:18px solid #c0392b;
}
.center{text-align:center;}
button{
  padding:12px 26px;
  border:none;
  border-radius:30px;
  background:linear-gradient(135deg,#2c5364,#203a43);
  color:#fff;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}
.logout{
  margin-top:25px;
  text-align:center;
}
.logout button{
  background:#c0392b;
}
.footer{
  margin-top:26px;
  text-align:center;
  font-size:12px;
  color:#777;
}
.footer div{margin-top:2px;}
</style>
</head>

<body>

<div class="card">
  <div class="header">Welcome</div>
  <div class="sub">Group Discussion & Seminar (ME3273)</div>

  <div id="content"></div>

  <div class="logout">
    <button onclick="logout()">Logout</button>
  </div>

  <div class="footer">
    Developed by Rajesh Akula
    <div>© 2026 · IIEST Shibpur</div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL =
"https://script.google.com/macros/s/AKfycbwBQJCxQHeKTUUpsFTxY1be58UvP0SEfg__Y9vlqMvpRHPOYvll2wDOiMt7VpImbEFIxw/exec";

const token = new URLSearchParams(window.location.search).get("token");
const content = document.getElementById("content");

/* ================= INIT ================= */
if(!token){
  content.innerHTML="<b>Invalid session. Please login again.</b>";
}else{
  showWheel();        // ALWAYS show wheel first
  checkAssignment(); // THEN check backend
}

/* ================= SHOW WHEEL ================= */
function showWheel(){
  content.innerHTML=`
    <div id="pointer"></div>
    <div id="wheel"></div>
    <div class="center section">
      <button onclick="spin()">SPIN & ASSIGN TOPIC</button>
    </div>
  `;
}

/* ================= CHECK ASSIGNMENT ================= */
function checkAssignment(){
  fetch(BACKEND_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"dashboard",
      token:token
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="ASSIGNED" && res.project && res.team){
      showAssigned(res.project, res.team);
    }
  })
  .catch(()=>{});
}

/* ================= SPIN ================= */
function spin(){
  const wheel=document.getElementById("wheel");
  wheel.style.transform=`rotate(${360*6+Math.random()*360}deg)`;
  setTimeout(assignTopic,4200);
}

/* ================= ASSIGN ================= */
function assignTopic(){
  fetch(BACKEND_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"assign",
      token:token
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.project && res.team){
      showAssigned(res.project, res.team);
    }
  });
}

/* ================= SHOW ASSIGNED ================= */
function showAssigned(topic, team){
  let html=`
    <div class="info-box">
      <div class="info-title">Assigned Topic</div>
      <div class="info-content">${topic}</div>
    </div>

    <div class="info-box">
      <div class="info-title">Group Members</div>
      <div class="info-content">
        ${team.map((s,i)=>`${i+1}. ${s.name} (${s.roll})`).join("<br>")}
      </div>
    </div>
  `;
  content.innerHTML=html;
}

/* ================= LOGOUT ================= */
function logout(){
  fetch(BACKEND_URL,{
    method:"POST",
    body:new URLSearchParams({
      action:"logout",
      token:token
    })
  }).finally(()=>{
    location.href="login.html";
  });
}
</script>

</body>
</html>
