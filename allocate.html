<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topic Allocation | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ---------- MAIN CARD ---------- */
.card{
  background:#ffffff;
  width:100%;
  max-width:520px;
  margin:24px 12px;
  padding:24px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}

h1{font-size:17px;text-align:center;color:#203a43;margin:0;}
h2{font-size:14px;text-align:center;color:#555;margin:6px 0 14px;}

.info{
  text-align:center;
  font-size:14px;
  margin-bottom:10px;
  color:#555;
}

/* ---------- COUNTDOWN ---------- */
.countdown{
  background:#fff8e1;
  color:#6d4c41;
  padding:10px;
  border-radius:10px;
  text-align:center;
  font-size:14px;
  font-weight:600;
}

/* ---------- WHEEL ---------- */
#wheelWrap{display:flex;justify-content:center;margin:18px 0;}
canvas{max-width:260px}

/* ---------- BUTTONS ---------- */
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:30px;
  background:linear-gradient(135deg,#2c5364,#203a43);
  color:#fff;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  margin-top:12px;
}
button:disabled{background:#999;cursor:not-allowed}

/* ---------- STATUS ---------- */
.status{margin-top:14px;text-align:center;font-size:14px}
.yellow{color:#f57f17}
.green{color:#1b5e20}
.red{color:#b71c1c}

/* ---------- INFO BOX ---------- */
.infoBox{
  background:#f5f7fa;
  border-radius:12px;
  padding:14px;
  margin-top:16px;
  font-size:14px;
}

/* ---------- FOOTER ---------- */
.footer{
  margin:12px 0 20px;
  text-align:center;
  font-size:13px;
  color:#e0e0e0;
}

/* ---------- MODAL ---------- */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;justify-content:center;align-items:center;
}
.modal-content{
  background:#fff;padding:22px;
  width:90%;max-width:420px;
  border-radius:14px;
}
textarea{
  width:100%;min-height:80px;
  padding:10px;border-radius:8px;border:1px solid #ccc;
}
.warn{color:#b71c1c;font-size:13px;margin-top:8px}
</style>
</head>

<body>

<div class="card">

  <h1 id="welcome">Welcome</h1>
  <h2>Group Discussion & Seminar (ME3273)</h2>

  <div class="countdown">
    ⏳ Time remaining: <span id="timeLeft">--:--:--</span>
  </div>

  <div id="wheelSection">
    <div class="info">
      Spin the coin to get your topic name for group discussion
    </div>
    <div id="wheelWrap">
      <canvas id="wheel" width="260" height="260"></canvas>
    </div>
    <button id="spinBtn" onclick="spin()">Spin the Coin</button>
  </div>

  <div id="status" class="status"></div>
  <div id="resultBox" class="infoBox" style="display:none"></div>

  <button id="seminarBtn" onclick="openModal()">Submit / Edit Seminar Topic</button>
  <button id="logoutBtn" onclick="logout()">Logout</button>

</div>

<div class="footer">
  <div>Developed by Rajesh Akula</div>
  <div>© 2026 · IIEST Shibpur</div>
</div>

<!-- ---------- MODAL ---------- -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Seminar Topic</h3>
    <textarea id="topicInput"></textarea>
    <div class="warn">
      The topic should be technical and related to any trending research topic in mechanical engineering.
    </div>
    <div class="status" id="topicStatus"></div>
    <button id="saveBtn" onclick="saveTopic()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbzaYTDl6fJeu2hlQr5jOPkUVD8p_bVni6-q-8FlJ3HG2RlV4zo0c-5g4UDDq40Z0V7FhA/exec";
const token=new URLSearchParams(location.search).get("token");
let DEADLINE=null, timer=null;
let angle=0, spinning=false;

function startCountdown(d){
  DEADLINE=new Date(d);
  timer=setInterval(()=>{
    const diff=DEADLINE-new Date();
    if(diff<=0){
      timeLeft.innerText="Deadline passed";
      spinBtn.style.display="none";
      seminarBtn.disabled=true;
      clearInterval(timer);return;
    }
    const h=Math.floor(diff/36e5),
          m=Math.floor(diff%36e5/6e4),
          s=Math.floor(diff%6e4/1e3);
    timeLeft.innerText=
      `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  },1000);
}

function spin(){
  if(spinning) return;
  spinning=true;
  spinBtn.disabled=true;
  status.className="status yellow";
  status.innerText="Allocating group topic, please wait…";

  let stop=Math.random()*360+2160;
  let id=setInterval(()=>{
    angle+=20;
    draw();
    if(angle>=stop){
      clearInterval(id);
      allocate();
    }
  },30);
}

function allocate(){
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"assign",token})})
  .then(r=>r.json()).then(res=>{
    status.innerText="";
    showResult(res.project,res.projectName,res.team,res.complete);
  });
}

function showResult(pid,pname,team,complete){
  let html=`<b>Assigned Topic:</b><br>${pid} – ${pname}<br><br><b>Group Members:</b><br>`;
  team.forEach((s,i)=>html+=`${i+1}. ${s.name} (${s.roll})<br>`);
  if(!complete){
    html+=`<div class="red" style="margin-top:8px">
      A few students haven't spun the wheel yet. Please login later to see full group details.
    </div>`;
  }
  resultBox.innerHTML=html;
  resultBox.style.display="block";
}

function logout(){
  logoutBtn.disabled=true;
  status.className="status yellow";
  status.innerText="Logging out, please wait…";
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"logout",token})})
  .finally(()=>location.href="login.html");
}

function openModal(){modal.style.display="flex";}
function closeModal(){modal.style.display="none";}

function saveTopic(){
  saveBtn.disabled=true;
  topicStatus.className="status yellow";
  topicStatus.innerText="Submitting…";
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveSeminarTopic",token,topic:topicInput.value
  })})
  .then(r=>r.json()).then(res=>{
    topicStatus.className="status green";
    topicStatus.innerText="Seminar topic submitted successfully";
  });
}

function draw(){
  const c=wheel.getContext("2d");
  c.clearRect(0,0,260,260);
  for(let i=0;i<9;i++){
    c.beginPath();
    c.moveTo(130,130);
    c.fillStyle=i%2?"#90caf9":"#bbdefb";
    c.arc(130,130,120,
      (i*40+angle)*Math.PI/180,
      ((i+1)*40+angle)*Math.PI/180);
    c.fill();
  }
}
</script>

</body>
</html>
